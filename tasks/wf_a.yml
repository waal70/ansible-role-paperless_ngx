---
 #   wf_name: "{{ item[0] }}"
 #   wf_filter: "{{ item[1] }}"
 #   wf_assigntag: "{{ item[2] }}"
 #   wf_triggertype: 2

- name: "Populate the JMESPath query strings"
  block:
    - name: "Populate tag for {{ wf_assigntag }}"
      ansible.builtin.set_fact:
        q_tag_id: "results[?name==`{{ wf_assigntag }}`].id"
      when: wf_assigntag != ''
### END BLOCK

- name: "Debug the combination of ids to set for workflow {{ wf_name }}"
  ansible.builtin.debug:
    msg:
      - "Tag type for {{ wf_assigntag }} is {{ tags_response.json | community.general.json_query(q_tag_id) | first | default('') }}"

- name: "Creating workflow {{ wf_name }}"
  ansible.builtin.uri:
    url: "{{ ppl_endpoint }}workflows/"
    method: POST
    headers:
      Authorization: "Token {{ auth_token }}"
    validate_certs: false
    body_format: json
    body: {
      "name": "{{ wf_name }}",
      "enabled": true,
      "triggers": [
        {
          "type": "{{ wf_triggertype }}",
          "filter_filename": "{{ wf_filter }}"
        }
      ],
      "actions": [
        {
          "type": 1,
          "assign_tags": "{{ tags_response.json | community.general.json_query(q_tag_id) }}"
        }
      ]
    }
    status_code:
      - 201
  when: "(wf_name not in wf_response.json.results | map(attribute='name') | list)"
  register: _result
  until: _result.status == 201
  retries: 3
  delay: 5
