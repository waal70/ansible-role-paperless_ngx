---
    # wf_name: "{{ item[0] }}"
    # wf_filter: "{{ item[1] }}"
    # wf_correspondent: "{{ item[2] }}"
    # wf_triggertype

- name: "Populate the JMESPath query strings"
  block:
    - name: "Populate correspondent for {{ wf_correspondent }}"
      ansible.builtin.set_fact:
        q_correspondent_id: "results[?name==`{{ wf_correspondent }}`].id"
      when: wf_correspondent != ''
### END BLOCK

- name: "Creating workflow {{ wf_name }}"
  ansible.builtin.uri:
    url: "{{ ppl_endpoint }}workflows/"
    method: POST
    headers:
      Authorization: "Token {{ auth_token }}"
    validate_certs: false
    body_format: json
    body: {
      "name": "{{ wf_name }}",
      "enabled": true,
      "triggers": [
        {
          "type": "{{ wf_triggertype }}",
          "filter_filename": "{{ wf_filter }}"
        }
      ],
      "actions": [
        {
          "type": 1,
          "assign_correspondent": "{{ correspondents_response.json | community.general.json_query(q_correspondent_id) | first | default('') }}"
        }
      ]
    }
    status_code:
      - 201
  when: "(wf_name not in wf_response.json.results | map(attribute='name') | list)"
  register: _result
  until: _result.status == 201
  retries: 3
  delay: 5
